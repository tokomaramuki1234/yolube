# GAS_INTEGRATED.gs v3.30 デプロイ手順

## バージョン情報
- **バージョン**: v3.30
- **更新日**: 2025-10-07
- **更新内容**: LockService導入（予約ID生成時の競合対策）

## 変更内容

### 1. LockService による予約ID生成の競合対策（重要）

#### 問題
複数のユーザーが**同時に**予約フォームを送信した場合、以下のシナリオでID重複が発生する可能性がありました：

```
時刻    | ユーザーA                        | ユーザーB
--------|----------------------------------|----------------------------------
10:00:00| getNextReservationId() 実行      |
10:00:01| → 現在の最大ID = 23              |
10:00:02| → 次のID = 24                    | getNextReservationId() 実行
10:00:03|                                  | → 現在の最大ID = 23（Aがまだ保存前）
10:00:04|                                  | → 次のID = 24（重複！）
10:00:05| ID=24でスプレッドシートに保存    |
10:00:06|                                  | ID=24でスプレッドシートに保存（衝突）
```

#### 解決策: LockService

Google Apps Scriptの`LockService`を使用して、ID生成処理を排他制御します。

```javascript
function getNextReservationId() {
  const lock = LockService.getScriptLock();

  try {
    // ロック取得を試行（最大30秒待機）
    const hasLock = lock.tryLock(30000);

    if (!hasLock) {
      throw new Error('予約が集中しています。しばらくしてから再度お試しください。');
    }

    // ここでID生成処理（排他制御された状態）
    const sheet = getReservationsSheet();
    const lastRow = sheet.getLastRow();
    // ...（ID生成ロジック）

    const nextId = maxId + 1;
    Logger.log(`Generated reservation ID: ${nextId} (lock acquired)`);
    return nextId;

  } catch (error) {
    Logger.log('Error in getNextReservationId: ' + error.toString());
    throw error;
  } finally {
    // 必ずロックを解放
    lock.releaseLock();
  }
}
```

#### 動作

```
時刻    | ユーザーA                        | ユーザーB
--------|----------------------------------|----------------------------------
10:00:00| ロック取得成功                   |
10:00:01| getNextReservationId() 実行      |
10:00:02| → 現在の最大ID = 23              | ロック取得試行（待機）
10:00:03| → 次のID = 24                    | （Aのロック解放待ち）
10:00:04| ID=24でスプレッドシートに保存    | （Aのロック解放待ち）
10:00:05| ロック解放                       |
10:00:06|                                  | ロック取得成功
10:00:07|                                  | getNextReservationId() 実行
10:00:08|                                  | → 現在の最大ID = 24
10:00:09|                                  | → 次のID = 25（正常！）
10:00:10|                                  | ID=25でスプレッドシートに保存
10:00:11|                                  | ロック解放
```

### 2. エラーハンドリングの改善

#### ロック取得失敗時
30秒以内にロックが取得できない場合、ユーザーに分かりやすいエラーメッセージを返します：

```javascript
if (!hasLock) {
  throw new Error('予約が集中しています。しばらくしてから再度お試しください。');
}
```

#### ログ出力の追加
デバッグ用にID生成時のログを追加：

```javascript
Logger.log(`Generated reservation ID: ${nextId} (lock acquired)`);
```

### 3. finally ブロックでの確実なロック解放

エラーが発生した場合でも、`finally`ブロックで必ずロックを解放します：

```javascript
} finally {
  // 必ずロックを解放
  lock.releaseLock();
}
```

## LockService の仕組み

### スクリプトロック（Script Lock）

- **スコープ**: 同一スクリプト内のすべての実行インスタンス
- **動作**: 1つの実行インスタンスだけがロックを取得できる
- **待機**: 他のインスタンスは`tryLock()`で待機

### ロックの種類

| ロック種類 | 説明 | 用途 |
|-----------|------|------|
| `ScriptLock` | スクリプト全体で排他 | ID生成など（今回使用） |
| `UserLock` | ユーザー単位で排他 | ユーザー固有データの更新 |
| `DocumentLock` | ドキュメント単位で排他 | 特定のファイル操作 |

### タイムアウト設定

```javascript
lock.tryLock(30000); // 30秒（30,000ミリ秒）
```

- **推奨値**: 10秒〜30秒
- **理由**: ID生成は通常1秒以内に完了。30秒あれば十分

## デプロイ手順

### 1. Google Apps Script エディタを開く
1. [Google Apps Script](https://script.google.com/) にアクセス
2. プロジェクト「YOLUBE統合システム」を開く

### 2. コードを更新
1. エディタで `GAS_INTEGRATED.gs` を開く
2. ローカルの `docs/GAS_INTEGRATED.gs` の内容を**全選択してコピー**
3. エディタ内の既存コードを**全削除**
4. コピーした内容を**貼り付け**
5. **`Ctrl+S` で保存**

### 3. デプロイ
1. 右上「デプロイ」→「**新しいデプロイ**」
2. 種類: ウェブアプリ
3. 説明: `v3.30: LockService導入（予約ID競合対策）`
4. 実行ユーザー: 自分
5. アクセス: 全員
6. **「デプロイ」をクリック**

### 4. 動作確認

#### 基本動作テスト
1. 予約フォームから1件送信
2. 予約IDが正常に発行されるか確認

#### 同時アクセステスト（推奨）
1. 2つのブラウザ（例: ChromeとFirefox）を開く
2. 両方で予約フォームを表示
3. **ほぼ同時に**送信ボタンをクリック
4. 両方の予約IDが異なることを確認

例：
- ブラウザA: 予約ID = 25
- ブラウザB: 予約ID = 26
- ✅ 重複なし！

## テスト項目

### 機能テスト
- [ ] 予約フォーム送信が正常に完了する
- [ ] 予約IDが連番で発行される（1, 2, 3, ...）
- [ ] 確認メールが届く
- [ ] 予約完了画面が表示される

### 競合対策テスト
- [ ] 2つのブラウザで同時送信してもIDが重複しない
- [ ] 3つ以上の同時送信でもIDが重複しない（余裕があれば）

### エラーハンドリングテスト
- [ ] 通常の予約は問題なく完了する
- [ ] エラー時にも適切なメッセージが表示される

### ログ確認
GASエディタのログで以下が確認できます：
```
Generated reservation ID: 25 (lock acquired)
Generated reservation ID: 26 (lock acquired)
```

## パフォーマンスへの影響

### 通常時（同時アクセスなし）
- **影響**: ほぼなし（ロック取得は数ミリ秒）
- **体感**: 変化なし

### 同時アクセス時
- **1人目**: 通常通り（ロック取得 → ID生成 → 保存）
- **2人目**: 1人目のロック解放を待機（1〜2秒程度）
- **3人目以降**: 順番待ち

**実際の影響**:
- YOLUBEのKe.イベントは月1回
- 同時アクセスは少ない
- 仮に5人が同時送信しても、5〜10秒で全員完了
- **体感**: ほとんど影響なし

## トラブルシューティング

### 問題: 「予約が集中しています」エラーが表示される

#### 原因1: 本当に多数の同時アクセス
**確認**: 管理画面で予約状況を確認

**対応**: 正常な動作。ユーザーに数秒待って再送信してもらう

#### 原因2: ロックが解放されていない（バグ）
**確認**: GASエディタのログで`releaseLock`が呼ばれているか確認

**対応**:
1. スクリプトを再起動（GASエディタで保存し直す）
2. それでもダメなら、LockServiceをリセット（手動で10分待機）

### 問題: ID生成が遅い

#### 確認方法
GASエディタのログでタイムスタンプを確認：
```
[10:00:01] Generated reservation ID: 25 (lock acquired)
[10:00:03] Generated reservation ID: 26 (lock acquired)
```

#### 正常範囲
- ID生成: 0.5秒〜2秒
- ロック待ち: 0秒〜5秒（同時アクセス時）

#### 異常値
- ID生成: 5秒以上
- ロック待ち: 10秒以上

**対応**: スプレッドシートのデータ量を確認（1,000件以上の場合は最適化を検討）

### 問題: IDが重複している

#### 確認方法
スプレッドシートのO列（予約ID）で重複を検索

#### 考えられる原因
1. **v3.30以前の予約**: 古いバージョンで発行されたID
2. **デプロイミス**: v3.30がデプロイされていない
3. **キャッシュ**: 古いバージョンが実行された

**対応**:
1. デプロイバージョンを確認（v3.30か？）
2. 最新のデプロイURLを使用しているか確認
3. 問題が続く場合は手動でIDを修正

## 技術的詳細

### LockService API

```javascript
// ロック取得
LockService.getScriptLock()  // スクリプトロック
LockService.getUserLock()    // ユーザーロック
LockService.getDocumentLock()// ドキュメントロック

// ロック操作
lock.tryLock(timeoutInMillis)  // タイムアウト付きロック取得
lock.waitLock(timeoutInMillis) // ロック取得（待機）
lock.hasLock()                 // ロック保持確認
lock.releaseLock()             // ロック解放
```

### 制限事項

1. **最大ロック時間**: 30秒（推奨）〜 300秒（上限）
2. **自動解放**: スクリプト終了時に自動解放
3. **デッドロック**: 発生しない（単一ロックのため）

## メリット・デメリット

### メリット
- ✅ ID重複が**完全に防止**される
- ✅ 連番IDを維持できる（ユーザーフレンドリー）
- ✅ 既存データとの互換性を保てる
- ✅ 実装がシンプル

### デメリット
- ⚠️ 同時アクセス時に若干の待機時間（1〜2秒）
- ⚠️ 30秒以上ロックが取れない場合はエラー

### 結論
**メリット >> デメリット**

YOLUBEの使用状況（月1回、同時アクセス少）では、デメリットはほぼ無視できます。

## 前バージョンからの変更まとめ

### v3.29 → v3.30
1. **LockService導入**
   - `getNextReservationId()`に排他制御追加
2. **エラーハンドリング改善**
   - ロック取得失敗時のエラーメッセージ追加
3. **ログ出力追加**
   - ID生成時のログ追加

### 影響範囲
- ✅ 予約ID生成のみ
- ✅ 他の機能に影響なし
- ✅ 既存データに影響なし

## 関連ファイル
- `docs/GAS_INTEGRATED.gs` - 本体コード（Line 1028-1078）
- `docs/README_GAS_v3.29.md` - 前バージョンのREADME

## 備考
- v3.29のCONFIG機能は維持
- v3.28のモバイル対応は維持
- すべての既存機能は維持

## 今後の拡張

将来的に検討可能な改善：
1. **ロック待機ログ**: 待機時間が長い場合にアラート
2. **ID生成の最適化**: データ量増加時の高速化
3. **タイムスタンプ付きID**: `20251007-001`形式（将来的な選択肢）
